# Source: https://github.com/amulya-labs/ai-dev-foundry
# License: MIT (https://opensource.org/licenses/MIT)

name: Claude Code Review

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to review (recommended; required for public/OSS manual runs)"
        required: false
        type: string

  pull_request:
    types:
      - opened
      - ready_for_review
      - review_requested
      - reopened

  issue_comment:
    types: [created]

concurrency:
  group: ${{
    (github.event_name == 'pull_request') &&
      format('{0}-pr-{1}', github.workflow, github.event.pull_request.number)
      ||
    (github.event_name == 'issue_comment' &&
     github.event.issue.pull_request &&
     startsWith(github.event.comment.body, '/claude-review') &&
     github.actor != 'claude[bot]') &&
      format('{0}-issue_comment-pr-{1}', github.workflow, github.event.issue.number)
      ||
    (github.event_name == 'workflow_dispatch') &&
      format('{0}-dispatch-pr-{1}', github.workflow, github.event.inputs.pr_number)
      ||
    format('{0}-noop-{1}', github.workflow, github.run_id)
    }}
  cancel-in-progress: true

jobs:
  # =============================
  # INTERNAL (non-public repos)
  # =============================
  claude-review-internal:
    if: |
      github.event.repository.visibility != 'public' && (
        github.event_name == 'workflow_dispatch' ||
        (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository) ||
        (
          github.event_name == 'issue_comment' &&
          github.event.issue.pull_request &&
          startsWith(github.event.comment.body, '/claude-review') &&
          !contains(github.event.comment.body, '@claude') &&
          (github.event.comment.author_association == 'MEMBER' || github.event.comment.author_association == 'OWNER' || github.event.comment.author_association == 'COLLABORATOR')
        )
      )
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Resolve PR number
        id: pr
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            echo "number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          else
            echo "number=${{ github.event.inputs.pr_number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: React to triggering comment
        if: github.event_name == 'issue_comment'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions" \
            -f content='eyes'

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          # For issue_comment / workflow_dispatch, checkout the PR head explicitly.
          # For pull_request, default ref is fine, but this also works consistently.
          ref: ${{ steps.pr.outputs.number != '' && format('refs/pull/{0}/head', steps.pr.outputs.number) || github.ref }}

      - name: Post review-started notice
        if: github.event_name == 'issue_comment'
        env:
          GH_TOKEN: ${{ github.token }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          gh pr comment "${{ steps.pr.outputs.number }}" \
            --repo "${{ github.repository }}" \
            --body "> Review in progress. [View run]($RUN_URL)"

      - name: Check PR size
        id: pr-size
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          STATS=$(gh pr view "${{ steps.pr.outputs.number }}" \
            --repo "${{ github.repository }}" \
            --json additions,deletions,changedFiles)
          FILES=$(echo "$STATS" | jq '.changedFiles')
          LINES=$(echo "$STATS" | jq '.additions + .deletions')
          if [ "$FILES" -gt 50 ] || [ "$LINES" -gt 3000 ]; then
            echo "strategy=summary" >> "$GITHUB_OUTPUT"
          else
            echo "strategy=detailed" >> "$GITHUB_OUTPUT"
          fi

      - name: Run Claude Code Review
        id: claude-review
        timeout-minutes: 30
        uses: anthropics/claude-code-action@v1
        with:
          # track_progress is limited to pull_request events. Enabling it for
          # issue_comment triggers causes a self-cancellation loop: the progress
          # comment fires a new issue_comment event that can land in the same
          # concurrency group and cancel the in-progress review before the
          # job-level `if` can reject it (concurrency is evaluated first).
          track_progress: ${{ github.event_name == 'pull_request' && github.event.action != 'review_requested' }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ steps.pr.outputs.number }}

            You are reviewing PR #${{ steps.pr.outputs.number }} in ${{ github.repository }}.
            The PR branch is already checked out in the current working directory.

            ## Phase 1 — Read (HARD CAP: 5 turns)
            1. Run `gh pr view ${{ steps.pr.outputs.number }} --json title,body,additions,deletions,changedFiles` for PR metadata.
            2. Run `gh pr diff ${{ steps.pr.outputs.number }}` to get the full diff.
            3. **If the PR has >50 changed files OR >3000 total lines (additions+deletions):**
               Switch to SUMMARY MODE — skip reading individual files, do NOT post inline comments,
               and reduce Phase 1 to a HARD CAP of 3 turns. Post a summary comment only (≤20 lines)
               focused on architecture concerns and high-risk areas.
            4. **Otherwise (DETAILED MODE):** only read individual files if a hunk is genuinely
               ambiguous — skip if the diff is self-evident. Stop reading and move to Phase 2
               before you hit the 5-turn cap.
            5. Categorize every finding before posting anything:
               - **Critical/Major**: bugs, security issues, logic errors, data loss risks, race conditions
               - **Minor**: style, naming, nits, minor inefficiencies

            ## Phase 2 — Comment (spend remaining turns here)
            **Inline comments** — use `mcp__github_inline_comment__create_inline_comment`:
            - Post inline comments ONLY for Critical/Major findings (DETAILED MODE only).
            - Cap at 10 inline comments. If you have more, include the rest in the summary.
            - Each inline comment must clearly state: what the problem is, why it matters, and a suggested fix.

            **Summary comment** — write to `/tmp/review.md` then run `gh pr comment ${{ steps.pr.outputs.number }} --body-file /tmp/review.md`:
            - Format:
              ```
              ## Code Review Summary

              ### Key Findings
              [Critical/Major items — reference inline comments where posted]

              ### Minor / Style Notes
              [Batched minor findings — no inline comments for these]

              ### Overall Assessment
              [1-2 sentences: approve, request changes, or note concerns]
              ```
            - If <20 lines changed and the PR is purely mechanical (renames, formatting, dependency bumps), skip inline comments entirely and just post the summary.

            **Rules**:
            - Only post GitHub comments — do not submit review text as conversation messages.
            - Do NOT use heredocs or command substitution in --body arguments.
            - Be concise. Avoid restating what the diff already shows.
          claude_args: |
            --max-turns 50
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(*),Read,Glob,Grep"

      - name: Post failure notice
        if: always() && steps.pr.outputs.number != ''
        env:
          GH_TOKEN: ${{ github.token }}
          REVIEW_OUTCOME: ${{ steps.claude-review.outcome }}
          JOB_STATUS: ${{ job.status }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          RUN_ID: ${{ github.run_id }}
          PR_NUM: ${{ steps.pr.outputs.number }}
          REPO: ${{ github.repository }}
        run: |
          # Skip if review succeeded
          if [ "$REVIEW_OUTCOME" = "success" ]; then
            exit 0
          fi

          # Determine failure reason
          if [ "$JOB_STATUS" = "cancelled" ]; then
            REASON="cancelled (superseded by a newer push or manually stopped)"
          elif [ -z "$REVIEW_OUTCOME" ] || [ "$REVIEW_OUTCOME" = "skipped" ]; then
            REASON="review step did not run (a prior step failed or was skipped)"
          else
            # Check if Claude posted any findings during this run
            RUN_STARTED=$(gh api "repos/$REPO/actions/runs/$RUN_ID" --jq '.created_at' 2>/dev/null || echo "")
            COMMENT_COUNT=0
            if [ -n "$RUN_STARTED" ]; then
              COMMENT_COUNT=$(gh api "repos/$REPO/issues/$PR_NUM/comments" \
                --jq "[.[] | select(.user.login == \"claude[bot]\") | select(.created_at > \"$RUN_STARTED\")] | length" \
                2>/dev/null || echo "0")
            fi
            if [ "${COMMENT_COUNT:-0}" -gt 0 ]; then
              REASON="reached its turn limit; findings above are valid but the review is incomplete"
            else
              REASON="failed before posting any findings"
            fi
          fi

          # Build comment body
          cat > /tmp/failure-notice.md <<EOF
          > **Note:** The automated code review did not complete — $REASON.
          >
          > Any inline comments posted above are valid findings, but the review may be incomplete.
          > [View workflow run]($RUN_URL) for details. Re-trigger with \`/claude-review\`.
          EOF

          gh pr comment "$PR_NUM" \
            --repo "$REPO" \
            --body-file /tmp/failure-notice.md

  # =============================
  # OSS / PUBLIC (public repos)
  # =============================
  claude-review-oss:
    # SECURITY: never checkout PR code in public/OSS mode. Use gh pr diff/view only.
    if: |
      github.event.repository.visibility == 'public' && (
        (
          github.event_name == 'issue_comment' &&
          github.event.issue.pull_request &&
          startsWith(github.event.comment.body, '/claude-review') &&
          !contains(github.event.comment.body, '@claude') &&
          (github.event.comment.author_association == 'MEMBER' || github.event.comment.author_association == 'OWNER' || github.event.comment.author_association == 'COLLABORATOR')
        )
        ||
        (
          github.event_name == 'pull_request' &&
          github.event.pull_request.head.repo.full_name == github.repository &&
          (
            github.event.pull_request.author_association == 'MEMBER' ||
            github.event.pull_request.author_association == 'OWNER' ||
            github.event.pull_request.author_association == 'COLLABORATOR'
          )
        )
        ||
        (
          github.event_name == 'workflow_dispatch' &&
          github.event.inputs.pr_number != ''
        )
      )
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Resolve PR number
        id: pr
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            echo "number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          else
            echo "number=${{ github.event.inputs.pr_number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: React to triggering comment
        if: github.event_name == 'issue_comment'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions" \
            -f content='eyes'

      - name: Run Claude Code Review (OSS)
        id: claude-review
        timeout-minutes: 30
        uses: anthropics/claude-code-action@v1
        with:
          track_progress: false
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ steps.pr.outputs.number }}

            You are reviewing PR #${{ steps.pr.outputs.number }} in ${{ github.repository }}.

            IMPORTANT: The PR code is NOT checked out locally. Do not use `Read`, `Glob`, or `Grep` on
            local files — they will not contain the PR's changes. Use only `gh` commands with
            `--repo ${{ github.repository }}` for all data access.

            ## Phase 1 — Read (spend ~3 turns here)
            1. Run `gh pr diff ${{ steps.pr.outputs.number }} --repo ${{ github.repository }}` to get the full diff.
            2. Run `gh pr view ${{ steps.pr.outputs.number }} --repo ${{ github.repository }} --json title,body,additions,deletions,changedFiles` for PR metadata.
            3. If any diff hunk lacks sufficient context, use `gh api` to fetch the full file:
               `gh api repos/${{ github.repository }}/contents/{path}?ref={head_sha} --jq .content | base64 -d`
            4. Categorize every finding before posting anything:
               - **Critical/Major**: bugs, security issues, logic errors, data loss risks, race conditions
               - **Minor**: style, naming, nits, minor inefficiencies

            ## Phase 2 — Comment (spend remaining turns here)
            **Inline comments** — use `mcp__github_inline_comment__create_inline_comment`:
            - Post inline comments ONLY for Critical/Major findings.
            - Cap at 10 inline comments. If you have more, include the rest in the summary.
            - Each inline comment must clearly state: what the problem is, why it matters, and a suggested fix.

            **Summary comment** — write to `/tmp/review.md` then run `gh pr comment ${{ steps.pr.outputs.number }} --repo ${{ github.repository }} --body-file /tmp/review.md`:
            - Format:
              ```
              ## Code Review Summary

              ### Key Findings
              [Critical/Major items — reference inline comments where posted]

              ### Minor / Style Notes
              [Batched minor findings — no inline comments for these]

              ### Overall Assessment
              [1-2 sentences: approve, request changes, or note concerns]
              ```
            - If <20 lines changed and the PR is purely mechanical (renames, formatting, dependency bumps), skip inline comments entirely and just post the summary.

            **Rules**:
            - Only post GitHub comments — do not submit review text as conversation messages.
            - Do NOT use heredocs or command substitution in --body arguments.
            - Always include `--repo ${{ github.repository }}` on every `gh` command.
            - Be concise. Avoid restating what the diff already shows.
          claude_args: |
            --max-turns 50
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(*)"

      - name: Post failure notice
        if: always() && steps.pr.outputs.number != ''
        env:
          GH_TOKEN: ${{ github.token }}
          REVIEW_OUTCOME: ${{ steps.claude-review.outcome }}
          JOB_STATUS: ${{ job.status }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          # Skip if review succeeded
          if [ "$REVIEW_OUTCOME" = "success" ]; then
            exit 0
          fi

          # Determine failure reason
          if [ "$JOB_STATUS" = "cancelled" ]; then
            REASON="cancelled (likely superseded by a newer push or manual cancellation)"
          elif [ -z "$REVIEW_OUTCOME" ] || [ "$REVIEW_OUTCOME" = "skipped" ]; then
            REASON="review step did not run (a prior step failed or was skipped)"
          else
            REASON="failed (timeout, max-turns exhausted, or internal error)"
          fi

          # Build comment body
          cat > /tmp/failure-notice.md <<EOF
          > **Note:** The automated code review did not complete — $REASON.
          >
          > Any inline comments posted above are valid findings, but the review may be incomplete.
          > [View workflow run]($RUN_URL) for details. Re-trigger with \`/claude-review\`.
          EOF

          gh pr comment "${{ steps.pr.outputs.number }}" \
            --repo "${{ github.repository }}" \
            --body-file /tmp/failure-notice.md
