# Source: https://github.com/amulya-labs/claude-code-config
# License: MIT (https://opensource.org/licenses/MIT)

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate-agents:
    name: Validate Agent Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install pyyaml

      - name: Validate agent frontmatter
        run: |
          python << 'EOF'
          import sys
          import yaml
          from pathlib import Path

          errors = []
          agents_dir = Path(".claude/agents")

          if not agents_dir.exists():
              print("No .claude/agents directory found")
              sys.exit(1)

          agent_files = list(agents_dir.glob("*.md"))
          if not agent_files:
              print("No agent files found")
              sys.exit(1)

          print(f"Found {len(agent_files)} agent file(s)")

          for agent_file in agent_files:
              print(f"\nValidating: {agent_file.name}")
              content = agent_file.read_text()

              # Check frontmatter delimiters
              if not content.startswith("---"):
                  errors.append(f"{agent_file.name}: Missing opening frontmatter delimiter (---)")
                  continue

              parts = content.split("---", 2)
              if len(parts) < 3:
                  errors.append(f"{agent_file.name}: Missing closing frontmatter delimiter (---)")
                  continue

              frontmatter_text = parts[1].strip()

              # Parse YAML
              try:
                  frontmatter = yaml.safe_load(frontmatter_text)
              except yaml.YAMLError as e:
                  errors.append(f"{agent_file.name}: Invalid YAML in frontmatter: {e}")
                  continue

              if not isinstance(frontmatter, dict):
                  errors.append(f"{agent_file.name}: Frontmatter must be a YAML object")
                  continue

              # Check required fields
              required_fields = ["name", "description", "source", "license"]
              for field in required_fields:
                  if field not in frontmatter:
                      errors.append(f"{agent_file.name}: Missing required field '{field}'")
                  elif not frontmatter[field]:
                      errors.append(f"{agent_file.name}: Field '{field}' is empty")

              # Validate optional fields
              if "model" in frontmatter:
                  valid_models = ["opus", "sonnet", "haiku"]
                  if frontmatter["model"] not in valid_models:
                      errors.append(f"{agent_file.name}: Invalid model '{frontmatter['model']}'. Must be one of: {valid_models}")

              # Check body content exists
              body = parts[2].strip()
              if not body:
                  errors.append(f"{agent_file.name}: Agent file has no content after frontmatter")

              if not errors or not any(agent_file.name in e for e in errors):
                  print(f"  ✓ Valid")

          if errors:
              print("\n" + "=" * 50)
              print("ERRORS:")
              for error in errors:
                  print(f"  ✗ {error}")
              sys.exit(1)

          print("\n" + "=" * 50)
          print(f"All {len(agent_files)} agent file(s) are valid!")
          EOF

  validate-hooks:
    name: Validate Hook Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Lint hook scripts
        run: |
          echo "Running shellcheck on hook scripts..."
          find .claude/hooks -name "*.sh" -exec shellcheck {} \;

      - name: Validate TOML config
        run: |
          echo "Validating TOML configuration..."
          python3 -c "
          import sys
          try:
              import tomllib
          except ImportError:
              import tomli as tomllib

          with open('.claude/hooks/bash-patterns.toml', 'rb') as f:
              config = tomllib.load(f)

          # Validate structure
          for category in ['deny', 'ask', 'allow']:
              if category not in config:
                  print(f'Warning: Missing [{category}] section')
                  continue
              for section, data in config[category].items():
                  if not isinstance(data, dict):
                      print(f'Error: {category}.{section} must be a table')
                      sys.exit(1)
                  if 'patterns' not in data:
                      print(f'Error: {category}.{section} missing patterns key')
                      sys.exit(1)
                  if not isinstance(data['patterns'], list):
                      print(f'Error: {category}.{section}.patterns must be a list')
                      sys.exit(1)

          print('TOML configuration is valid')
          "

      - name: Run hook tests
        run: |
          echo "Running bash hook tests..."
          tests/test-validate-bash.sh

  validate-manage-agents:
    name: Validate manage-claude-code-config.sh
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Run manage-claude-code-config tests
        run: tests/test-manage-agents.sh

  validate-attributions:
    name: Validate Attributions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check LICENSE file exists
        run: |
          if [ ! -f LICENSE ]; then
            echo "ERROR: LICENSE file not found in repository root"
            exit 1
          fi
          echo "✓ LICENSE file exists"

      - name: Validate script attributions
        run: |
          errors=0

          echo "=== Checking shell scripts ==="
          for script in .claude/hooks/*.sh scripts/*.sh scripts/git-subtree-mgr; do
            if [ -f "$script" ]; then
              echo -n "Checking $script... "
              if ! grep -q "Source:.*github.com/amulya-labs/claude-code-config" "$script"; then
                echo "MISSING source attribution"
                errors=$((errors + 1))
              elif ! grep -qi "License:.*MIT" "$script"; then
                echo "MISSING license attribution"
                errors=$((errors + 1))
              else
                echo "✓"
              fi
            fi
          done

          echo ""
          echo "=== Checking Python scripts ==="
          for script in .claude/hooks/*.py; do
            if [ -f "$script" ]; then
              echo -n "Checking $script... "
              if ! grep -q "Source:.*github.com/amulya-labs/claude-code-config" "$script"; then
                echo "MISSING source attribution"
                errors=$((errors + 1))
              elif ! grep -qi "License:.*MIT" "$script"; then
                echo "MISSING license attribution"
                errors=$((errors + 1))
              else
                echo "✓"
              fi
            fi
          done

          echo ""
          echo "=== Checking TOML configs ==="
          for config in .claude/hooks/*.toml; do
            if [ -f "$config" ]; then
              echo -n "Checking $config... "
              if ! grep -q "Source:.*github.com/amulya-labs/claude-code-config" "$config"; then
                echo "MISSING source attribution"
                errors=$((errors + 1))
              elif ! grep -qi "License:.*MIT" "$config"; then
                echo "MISSING license attribution"
                errors=$((errors + 1))
              else
                echo "✓"
              fi
            fi
          done

          echo ""
          echo "=== Checking workflow files ==="
          for wf in .github/workflows/ci.yml .github/workflows/claude.yml .github/workflows/claude-code-review.yml; do
            if [ -f "$wf" ]; then
              echo -n "Checking $wf... "
              if ! grep -q "Source:.*github.com/amulya-labs/claude-code-config" "$wf"; then
                echo "MISSING source attribution"
                errors=$((errors + 1))
              elif ! grep -qi "License:.*MIT" "$wf"; then
                echo "MISSING license attribution"
                errors=$((errors + 1))
              else
                echo "✓"
              fi
            fi
          done

          echo ""
          if [ $errors -gt 0 ]; then
            echo "ERROR: $errors file(s) missing proper attributions"
            echo ""
            echo "Required format for scripts:"
            echo "  # Source: https://github.com/amulya-labs/claude-code-config"
            echo "  # License: MIT (https://opensource.org/licenses/MIT)"
            exit 1
          fi

          echo "All files have proper attributions!"
